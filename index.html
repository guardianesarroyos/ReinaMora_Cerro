<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reina Mora - Datos Meteorológicos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --color-primario: #4a8fe7;
      --color-secundario: #ff9e00;
      --fondo-oscuro: #0f172a;
      --fondo-tarjeta: #1e293b;
      --texto-claro: #f8fafc;
      --texto-secundario: #94a3b8;
    }
    
    body {
      margin: 0;
      padding: 1rem;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--fondo-oscuro);
      color: var(--texto-claro);
      line-height: 1.5;
    }
    
    .contenedor {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .encabezado {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #334155;
    }
    
    .encabezado h1 {
      color: var(--color-primario);
      margin-bottom: 0.5rem;
    }
    
    .encabezado h2 {
      color: var(--color-secundario);
      margin-top: 0;
      font-size: 1.2rem;
    }
    
    .tarjeta-estacion {
      background-color: var(--fondo-tarjeta);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .nombre-estacion {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      color: var(--color-secundario);
      font-size: 1.2rem;
      font-weight: bold;
    }
    
    .datos-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    
    .dato-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }
    
    .dato-icono {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      color: var(--color-primario);
    }
    
    .dato-valor {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0.2rem 0;
    }
    
    .dato-etiqueta {
      font-size: 0.8rem;
      color: var(--texto-secundario);
      text-align: center;
    }
    
    .actualizacion {
      font-size: 0.8rem;
      text-align: right;
      color: var(--texto-secundario);
      margin-top: 1rem;
    }
    
    .footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.8rem;
      color: var(--texto-secundario);
    }
    
    .dato-lluvia-estimado {
      position: relative;
    }
    
    .dato-lluvia-estimado::after {
      content: "†";
      font-size: 0.6rem;
      vertical-align: super;
      color: var(--color-secundario);
    }
    
    @media (max-width: 480px) {
      .datos-container {
        grid-template-columns: 1fr;
      }
      
      .dato-item {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        text-align: left;
      }
      
      .dato-icono {
        margin-bottom: 0;
        margin-right: 1rem;
      }
      
      .dato-info {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="contenedor">
    <div class="encabezado">
      <h1><i class="fas fa-mountain"></i> Reina Mora</h1>
      <h2>Monitoreo Meteorológico</h2>
    </div>
    
    <!-- Estación Lomas de Cauquen -->
    <div class="tarjeta-estacion">
      <div class="nombre-estacion">
        <i class="fas fa-cloud-sun"></i>
        <span>Lomas de Cauquen (900 mts) - IDEPAR37</span>
      </div>
      
      <div class="datos-container">
        <div class="dato-item">
          <div class="dato-icono"><i class="fas fa-temperature-high"></i></div>
          <div class="dato-info">
            <div class="dato-valor" id="temp-principal">-- °C</div>
            <div class="dato-etiqueta">Temperatura</div>
          </div>
        </div>
        
        <div class="dato-item">
          <div class="dato-icono"><i class="fas fa-person-booth"></i></div>
          <div class="dato-info">
            <div class="dato-valor" id="st-principal">-- °C</div>
            <div class="dato-etiqueta">Sensación Térmica</div>
          </div>
        </div>
        
        <div class="dato-item">
          <div class="dato-icono"><i class="fas fa-wind"></i></div>
          <div class="dato-info">
            <div class="dato-valor" id="viento-principal">-- km/h</div>
            <div class="dato-etiqueta">Viento</div>
          </div>
        </div>
        
        <div class="dato-item">
          <div class="dato-icono"><i class="fas fa-cloud-rain"></i></div>
          <div class="dato-info">
            <div class="dato-valor" id="lluvia-principal">-- mm</div>
            <div class="dato-etiqueta">Lluvia 24h</div>
          </div>
        </div>
      </div>
      
      <div class="actualizacion" id="actualizacion-principal">Actualizando datos...</div>
    </div>
    
    <!-- Estación Villa Catedral (Cerro Catedral) -->
    <div class="tarjeta-estacion">
      <div class="nombre-estacion">
        <i class="fas fa-snowflake"></i>
        <span>Villa Catedral (1070 mts) - IBARIL29</span>
      </div>
      
      <div class="datos-container">
        <div class="dato-item">
          <div class="dato-icono"><i class="fas fa-temperature-high"></i></div>
          <div class="dato-info">
            <div class="dato-valor" id="temp-secundaria">-- °C</div>
            <div class="dato-etiqueta">Temperatura</div>
          </div>
        </div>
        
        <div class="dato-item">
          <div class="dato-icono"><i class="fas fa-person-booth"></i></div>
          <div class="dato-info">
            <div class="dato-valor" id="st-secundaria">-- °C</div>
            <div class="dato-etiqueta">Sensación Térmica</div>
          </div>
        </div>
        
        <div class="dato-item">
          <div class="dato-icono"><i class="fas fa-wind"></i></div>
          <div class="dato-info">
            <div class="dato-valor" id="viento-secundaria">-- km/h</div>
            <div class="dato-etiqueta">Viento</div>
          </div>
        </div>
        
        <div class="dato-item">
          <div class="dato-icono"><i class="fas fa-cloud-rain"></i></div>
          <div class="dato-info">
            <div class="dato-valor" id="lluvia-secundaria">-- mm</div>
            <div class="dato-etiqueta">Lluvia/Nieve 24h</div>
          </div>
        </div>
      </div>
      
      <div class="actualizacion" id="actualizacion-secundaria">Actualizando datos...</div>
    </div>
    
    <div class="footer">
      <p>Actualización automática cada 5 minutos</p>
      <p>Datos proporcionados por estaciones meteorológicas locales</p>
      <p class="dato-lluvia-estimado" style="display: inline-block; margin-top: 0.5rem;">† Valor estimado cuando no hay datos precisos</p>
    </div>
  </div>

  <script>
    // Configuración final
    const estaciones = {
      IDEPAR37: {
        nombre: "Lomas de Cauquen (900 mts)",
        prefijo: "principal"
      },
      IBARIL29: {
        nombre: "Villa Catedral (1070 mts)",
        prefijo: "secundaria"
      }
    };
    
    const apiKey = "6532d6454b8aa370768e63d6ba5a832e";
    const intervaloActualizacion = 5 * 60 * 1000; // 5 minutos
    
    // Función para formatear hora
    function formatearHora(fecha) {
      return new Date(fecha).toLocaleTimeString('es-AR', { 
        hour: '2-digit', 
        minute: '2-digit'
      });
    }
    
    // Función para obtener lluvia acumulada en 24h
    async function obtenerLluvia24h(idEstacion) {
      try {
        // 1. Intentamos con el endpoint diario
        const fechaActual = new Date();
        const fechaAyer = new Date(fechaActual);
        fechaAyer.setDate(fechaAyer.getDate() - 1);
        
        const urlDiario = `https://api.weather.com/v2/pws/history/daily?stationId=${idEstacion}&format=json&units=m&apiKey=${apiKey}&startDate=${fechaAyer.toISOString().split('T')[0]}&endDate=${fechaActual.toISOString().split('T')[0]}`;
        
        const response = await fetch(urlDiario);
        const data = await response.json();
        
        if (data.observations?.length > 0) {
          const lluvia = data.observations[0].metric.precipTotal;
          if (lluvia !== undefined) {
            return {
              valor: lluvia.toFixed(1),
              estimado: false
            };
          }
        }
        
        // 2. Si falla, intentamos con histórico horario
        const urlHorario = `https://api.weather.com/v2/pws/history/hourly?stationId=${idEstacion}&format=json&units=m&apiKey=${apiKey}&startDate=${fechaAyer.toISOString().split('T')[0]}`;
        
        const responseHorario = await fetch(urlHorario);
        const dataHorario = await responseHorario.json();
        
        if (dataHorario.observations?.length > 0) {
          const lluvia24h = dataHorario.observations.reduce((total, obs) => {
            return total + (obs.metric.precipTotal || 0);
          }, 0);
          
          return {
            valor: lluvia24h.toFixed(1),
            estimado: false
          };
        }
      } catch (error) {
        console.error("Error al obtener lluvia 24h:", error);
      }
      
      // 3. Si todo falla, retornamos 0.0 como estimado
      return {
        valor: "0.0",
        estimado: true
      };
    }
    
    // Obtener datos actuales de una estación
    async function obtenerDatosEstacion(idEstacion) {
      try {
        const url = `https://api.weather.com/v2/pws/observations/current?stationId=${idEstacion}&format=json&units=m&apiKey=${apiKey}`;
        const respuesta = await fetch(url);
        
        if (!respuesta.ok) throw new Error("Error en la respuesta");
        
        const datos = await respuesta.json();
        
        if (datos.observations?.length > 0) {
          const obs = datos.observations[0].metric;
          const lluvia24h = await obtenerLluvia24h(idEstacion);
          
          return {
            temperatura: obs.temp,
            sensacionTermica: obs.heatIndex || obs.windChill || obs.temp,
            viento: obs.windSpeed,
            lluvia: lluvia24h.valor,
            lluviaEstimada: lluvia24h.estimado,
            actualizacion: datos.observations[0].obsTimeLocal
          };
        }
      } catch (error) {
        console.error(`Error obteniendo datos de ${idEstacion}:`, error);
        return null;
      }
    }
    
    // Actualizar interfaz de una estación
    function actualizarInterfazEstacion(datos, idEstacion) {
      if (!datos) {
        document.getElementById(`actualizacion-${estaciones[idEstacion].prefijo}`)
          .textContent = "Error cargando datos";
        return;
      }
      
      const prefijo = estaciones[idEstacion].prefijo;
      
      // Actualizar valores
      document.getElementById(`temp-${prefijo}`).textContent = 
        `${datos.temperatura?.toFixed(1) || '--'} °C`;
      document.getElementById(`st-${prefijo}`).textContent = 
        `${datos.sensacionTermica?.toFixed(1) || '--'} °C`;
      document.getElementById(`viento-${prefijo}`).textContent = 
        `${datos.viento?.toFixed(1) || '--'} km/h`;
      
      // Manejo especial de lluvia
      const lluviaElement = document.getElementById(`lluvia-${prefijo}`);
      lluviaElement.textContent = `${datos.lluvia || '0.0'} mm`;
      
      if (datos.lluviaEstimada) {
        lluviaElement.classList.add('dato-lluvia-estimado');
        lluviaElement.title = "Valor estimado (no se pudo obtener dato preciso)";
      } else {
        lluviaElement.classList.remove('dato-lluvia-estimado');
        lluviaElement.removeAttribute('title');
      }
      
      // Actualizar marca de tiempo
      const horaActualizacion = formatearHora(datos.actualizacion);
      document.getElementById(`actualizacion-${prefijo}`).textContent = 
        `Actualizado: ${horaActualizacion}`;
    }
    
    // Actualizar todas las estaciones
    async function actualizarTodasEstaciones() {
      for (const idEstacion of Object.keys(estaciones)) {
        const datos = await obtenerDatosEstacion(idEstacion);
        actualizarInterfazEstacion(datos, idEstacion);
      }
    }
    
    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
      // Primera actualización inmediata
      actualizarTodasEstaciones();
      
      // Actualización periódica cada 5 minutos
      setInterval(actualizarTodasEstaciones, intervaloActualizacion);
    });
  </script>
</body>
</html>