<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>Monitor Meteo Cerros</title>
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="theme-color" content="#ff7b25">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background-color: transparent !important;
            color: #e0e0e0;
            padding: 8px;
            max-width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-x: hidden;
        }

        h1, h2, h3, h4 {
            color: #ff7b25;
            text-align: center;
            margin-bottom: 8px;
        }

        #update-time {
            font-size: 0.8rem;
            color: #aaa;
            text-align: center;
            margin-bottom: 16px;
        }

        .stations-container {
            display: flex;
            flex-wrap: wrap; /* Permite que las burbujas se ajusten en varias líneas si no hay espacio */
            gap: 16px; /* Espacio entre las burbujas */
            justify-content: center;
            padding: 16px;
            width: 100%; /* Ocupa todo el ancho disponible */
            max-width: 1200px; /* Ancho máximo para el contenedor */
        }

        .station {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1; /* Permite que las burbujas crezcan para llenar el espacio */
            min-width: 280px; /* Ancho mínimo para que no se hagan demasiado pequeñas */
            max-width: 350px; /* Ancho máximo para cada burbuja */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s ease-in-out;
        }

        .station:hover {
            transform: translateY(-5px);
        }

        .station-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff7b25;
            margin-bottom: 12px;
            text-align: center;
        }

        .station-data {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 12px;
            flex-wrap: wrap; /* Asegura que las columnas de datos se ajusten si el espacio es limitado */
        }

        .data-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 8px;
        }

        .temp-highlight {
            font-size: 2.2rem;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 8px;
        }

        .wind-container, .rain-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 8px;
        }

        .wind-rose {
            width: 80px;
            height: 80px;
            margin-bottom: 8px;
        }

        .compass-circle {
            width: 100%;
            height: 100%;
            border: 2px solid #f0711c;
            border-radius: 50%;
            position: relative; /* ¡Esencial para el posicionamiento de las letras! */
        }

        .compass-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #f0711c; /* Color de la flecha */
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            transform-origin: bottom center; /* Para rotar desde la base */
        }

        .compass-direction {
            position: absolute;
            font-size: 0.5rem;
            font-weight: bold;
            color: #e0e0e0;
            /* No se necesita top/left/etc. aquí, se definen en las clases específicas */
        }

        /* Posicionamiento específico para cada punto cardinal */
        .direction-north {
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
        }
        .direction-east {
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
        }
        .direction-south {
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
        }
        .direction-west {
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
        }


        .wind-speed, .wind-gust {
            font-size: 0.9rem;
            color: #ccc;
            text-align: center;
        }

        .rain-amount {
            font-size: 0.9rem;
            color: #ccc;
            text-align: center;
        }

        .rain-selector {
            display: flex;
            margin-top: 8px;
        }

        .rain-selector button {
            background-color: transparent;
            border: 1px solid #ff7b25;
            color: #ff7b25;
            padding: 4px 8px;
            margin: 0 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background-color 0.2s;
        }

        .rain-selector button.active {
            background-color: #ff7b25;
            color: #1a1a1a;
        }

        .rain-selector button:hover:not(.active) {
            background-color: rgba(255, 123, 37, 0.2);
        }

        .error {
            color: #ff4d4d;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 10px;
            display: block; /* Asegura que el error ocupe su propia línea */
        }

        /* Estilos específicos para cada estación */
        .station-primary {
            background-color: rgba(255, 123, 37, 0.15); /* Naranja más tenue */
            border-left: 3px solid #ff7b25; /* Borde naranja */
        }
        .station-primary .station-name, .station-primary .temp-highlight {
            color: #ff7b25;
        }
        .station-primary .compass-circle {
            border-color: #f0711c; /* Naranja medio */
        }
        .station-primary .wind-speed, .station-primary .wind-gust, .station-primary .rain-amount {
            color: #ff914d; /* Naranja más claro */
        }

        .station-secondary {
            background-color: rgba(0, 212, 255, 0.15); /* Azul más tenue */
            border-left: 3px solid #00d4ff; /* Borde azul */
        }
        .station-secondary .station-name, .station-secondary .temp-highlight {
            color: #00d4ff;
        }
        .station-secondary .compass-circle {
            border-color: #00b0e0; /* Azul medio */
        }
        .station-secondary .wind-speed, .station-secondary .wind-gust, .station-secondary .rain-amount {
            color: #00e8ff; /* Azul más claro */
        }

        .station-tertiary { /* CORREGIDO: ahora usa 'tertiary' */
            background-color: rgba(69, 69, 69, 0.15); /* Gris/Oscuro más tenue */
            border-left: 3px solid #4a90e2; /* Borde azul oscuro */
        }
        .station-tertiary .station-name, .station-tertiary .temp-highlight { /* CORREGIDO: ahora usa 'tertiary' */
            color: #4a90e2;
        }
        .station-tertiary .compass-circle { /* CORREGIDO: ahora usa 'tertiary' */
            border-color: #2374d0; /* Azul oscuro medio */
        }
        .station-tertiary .wind-speed, .station-tertiary .wind-gust, .station-tertiary .rain-amount { /* CORREGIDO: ahora usa 'tertiary' */
            color: #3279ca; /* Azul oscuro más claro */
        }
        .station-tertiary .rain-selector button { /* CORREGIDO: ahora usa 'tertiary' */
            border-color: #4a90e2;
            color: #4a90e2;
        }
        .station-tertiary .rain-selector button.active { /* CORREGIDO: ahora usa 'tertiary' */
            background-color: #4a90e2 !important;
        }

        /* Sección de Pronóstico */
        .forecast-section {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            text-align: center;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 16px;
        }

        .forecast-day {
            background-color: rgba(50, 50, 50, 0.8);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #ccc;
        }

        .forecast-day img {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
        }

        .forecast-day .day-name {
            font-weight: bold;
            color: #ff7b25;
            margin-bottom: 3px;
        }

        .forecast-day .temp-range {
            font-size: 0.9rem;
            color: #00d4ff;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <h1>MONITOR METEOROLÓGICO INTELIGENTE</h1>
    <p id="update-time">Cargando datos...</p>

    <section id="stations-section" class="stations-container">
        <div class="station station-primary">
            <div class="station-name">Cerro Otto, ppg. (1422 m.s.n.m)</div>
            <div class="station-data">
                <div class="data-column">
                    <div class="temp-highlight" id="temp-primary">--°C</div>
                </div>
                <div class="data-column">
                    <div class="wind-container">
                        <div class="wind-rose">
                            <div class="compass-circle">
                                <div class="compass-arrow" id="wind-arrow-primary"></div>
                                <div class="compass-direction direction-north">N</div>
                                <div class="compass-direction direction-east">E</div>
                                <div class="compass-direction direction-south">S</div>
                                <div class="compass-direction direction-west">O</div>
                            </div>
                        </div>
                        <div class="wind-speed" id="wind-speed-primary">-- km/h (--)</div>
                        <div class="wind-gust" id="wind-gust-primary">Ráfagas: -- km/h</div>
                    </div>
                </div>
                <div class="data-column">
                    <div class="rain-container">
                        <div class="rain-amount" id="rain-primary">
                            <div>Lluvias: -- mm</div>
                            <div>Nieve: -- cm</div>
                        </div>
                        <div class="rain-selector">
                            <button class="active" data-period="24h">24h</button>
                            <button data-period="48h">48h</button>
                            <button data-period="72h">72h</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="error" id="error-primary" style="display: none;"></div>
        </div>

        <div class="station station-secondary">
            <div class="station-name">Villa Catedral (1070 m.s.n.m)</div>
            <div class="station-data">
                <div class="data-column">
                    <div class="temp-highlight" id="temp-secondary">--°C</div>
                </div>
                <div class="data-column">
                    <div class="wind-container">
                        <div class="wind-rose">
                            <div class="compass-circle">
                                <div class="compass-arrow" id="wind-arrow-secondary"></div>
                                <div class="compass-direction direction-north">N</div>
                                <div class="compass-direction direction-east">E</div>
                                <div class="compass-direction direction-south">S</div>
                                <div class="compass-direction direction-west">O</div>
                            </div>
                        </div>
                        <div class="wind-speed" id="wind-speed-secondary">-- km/h (--)</div>
                        <div class="wind-gust" id="wind-gust-secondary">Ráfagas: -- km/h</div>
                    </div>
                </div>
                <div class="data-column">
                    <div class="rain-container">
                        <div class="rain-amount" id="rain-secondary">
                            <div>Lluvias: -- mm</div>
                            <div>Nieve: -- cm</div>
                        </div>
                        <div class="rain-selector">
                            <button class="active" data-period="24h">24h</button>
                            <button data-period="48h">48h</button>
                            <button data-period="72h">72h</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="error" id="error-secondary" style="display: none;"></div>
        </div> <div class="station station-tertiary">
            <div class="station-name">Lomas del Cauquén (932 m.s.n.m)</div>
            <div class="station-data">
                <div class="data-column">
                    <div class="temp-highlight" id="temp-tertiary">--°C</div>
                </div>
                <div class="data-column">
                    <div class="wind-container">
                        <div class="wind-rose">
                            <div class="compass-circle">
                                <div class="compass-arrow" id="wind-arrow-tertiary"></div>
                                <div class="compass-direction direction-north">N</div>
                                <div class="compass-direction direction-east">E</div>
                                <div class="compass-direction direction-south">S</div>
                                <div class="compass-direction direction-west">O</div>
                            </div>
                        </div>
                        <div class="wind-speed" id="wind-speed-tertiary">-- km/h (--)</div>
                        <div class="wind-gust" id="wind-gust-tertiary">Ráfagas: -- km/h</div>
                    </div>
                </div>
                <div class="data-column">
                    <div class="rain-container">
                        <div class="rain-amount" id="rain-tertiary">
                            <div>Lluvias: -- mm</div>
                            <div>Nieve: -- cm</div>
                        </div>
                        <div class="rain-selector">
                            <button class="active" data-period="24h">24h</button>
                            <button data-period="48h">48h</button>
                            <button data-period="72h">72h</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="error" id="error-tertiary" style="display: none;"></div>
        </div>
    </section>

    <section id="forecast-section" class="forecast-section">
        <h2>Pronóstico Extendido</h2>
        <div id="forecast-container" class="forecast-grid">
            <div class="forecast-day">Cargando pronóstico...</div>
        </div>
    </section>

    <script>
        // Configuración de API Key (cargada desde config.js si usas un archivo separado)
        // const wundergroundApiKey = window.apiKeys.wunderground; 
        // Si no usas config.js o tienes problemas, puedes definirla directamente aquí:
        const wundergroundApiKey = "6532d6454b8aa370768e63d6ba5a832e"; // ¡IMPORTANTE: Reemplaza con tu propia API Key de Wunderground!

        // Configuración de estaciones Wunderground
        const estaciones = {
            primary: { 
               id: "IDEPAR138", // Cerro Otto
                nombre: "Cerro Otto, ppg.",
                elevacion: "1422 m.s.n.m"                        
            },            
            secondary: { 
                id: "IBARIL29", // Villa Catedral
                nombre: "Villa Catedral",
                elevacion: "1070 m.s.n.m"
            },
            tertiary: { 
                id: "IDEPAR37", // Lomas del Cauquén
                nombre: "Lomas del Cauquén",
                elevacion: "932 m.s.n.m"
            }
        };

        // Función para obtener datos de Wunderground
        async function obtenerDatosWunderground(stationId) {
            const url = `https://api.weather.com/v2/pws/observations/current?stationId=${stationId}&format=json&units=m&apiKey=${wundergroundApiKey}`;
            const response = await fetch(url);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error al obtener datos de ${stationId}: ${response.status} - ${errorText}`);
            }
            const data = await response.json();
            if (!data.observations || data.observations.length === 0) {
                throw new Error(`No se encontraron observaciones para la estación ${stationId}.`);
            }
            return data.observations[0];
        }

        // Función para actualizar los datos en el HTML
        function actualizarEstacion(datos, prefix) {
            const tempElement = document.getElementById(`temp-${prefix}`);
            const windSpeedElement = document.getElementById(`wind-speed-${prefix}`);
            const windGustElement = document.getElementById(`wind-gust-${prefix}`);
            const windArrowElement = document.getElementById(`wind-arrow-${prefix}`);
            const rainElement = document.getElementById(`rain-${prefix}`);
            const errorElement = document.getElementById(`error-${prefix}`);
            const stationNameElement = document.getElementById(`station-name-${prefix}`); // Assuming you might have unique names

            if (tempElement) {
                tempElement.textContent = `${datos.metric.temp}°C`;
            }
            if (windSpeedElement) {
                windSpeedElement.textContent = `${datos.metric.windspeed} km/h (${datos.imperial.winddir}) `;
            }
            if (windGustElement) {
                windGustElement.textContent = `Ráfagas: ${datos.metric.windgust} km/h`;
            }
            if (windArrowElement) {
                windArrowElement.style.transform = `translateX(-50%) rotate(${datos.winddir}deg)`;
            }
            if (rainElement) {
                rainElement.innerHTML = `
                    <div>Lluvias: ${datos.metric.precipTotal} mm</div>
                    <div>Nieve: ${datos.metric.snowTotal} cm</div>
                `;
            }
            if (errorElement) {
                errorElement.style.display = 'none'; // Ocultar errores si la actualización es exitosa
            }
        }

        // Función para mostrar errores
        function mostrarError(mensaje, prefix) {
            const errorElement = document.getElementById(`error-${prefix}`);
            if (errorElement) {
                errorElement.textContent = `Error: ${mensaje}`;
                errorElement.style.display = 'block';
            }
            // También puedes establecer los valores a '--' si hay un error
            document.getElementById(`temp-${prefix}`).textContent = '--°C';
            document.getElementById(`wind-speed-${prefix}`).textContent = '-- km/h (--)';
            document.getElementById(`wind-gust-${prefix}`).textContent = 'Ráfagas: -- km/h';
            document.getElementById(`rain-${prefix}`).innerHTML = '<div>Lluvias: -- mm</div><div>Nieve: -- cm</div>';
        }

        // Función para cargar el pronóstico de 7 días
        async function cargarPronostico() {
            const forecastContainer = document.getElementById('forecast-container');
            forecastContainer.innerHTML = '<div class="forecast-day">Cargando pronóstico...</div>'; // Mensaje de carga

            const lat = -34.40; // Latitud para el pronóstico general (ajusta si es necesario)
            const lon = -58.70; // Longitud para el pronóstico general (ajusta si es necesario)
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=America%2FSao_Paulo`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (!data.daily) {
                    throw new Error("Datos de pronóstico no disponibles.");
                }

                forecastContainer.innerHTML = ''; // Limpiar mensaje de carga

                data.daily.time.forEach((time, index) => {
                    const date = new Date(time);
                    const dayName = date.toLocaleDateString('es-AR', { weekday: 'short' });
                    const maxTemp = data.daily.temperature_2m_max[index];
                    const minTemp = data.daily.temperature_2m_min[index];
                    const weatherCode = data.daily.weathercode[index];
                    const weatherIcon = getWeatherIcon(weatherCode); // Función para obtener icono

                    const dayElement = document.createElement('div');
                    dayElement.classList.add('forecast-day');
                    dayElement.innerHTML = `
                        <div class="day-name">${dayName}</div>
                        <img src="icons/${weatherIcon}.svg" alt="Clima">
                        <div class="temp-range">${minTemp.toFixed(0)}°C - ${maxTemp.toFixed(0)}°C</div>
                    `;
                    forecastContainer.appendChild(dayElement);
                });

            } catch (error) {
                console.error("Error al cargar el pronóstico:", error);
                forecastContainer.innerHTML = '<div class="error">Error al cargar el pronóstico.</div>';
            }
        }

        // Función auxiliar para obtener iconos basados en Weather Code (simplificado)
        function getWeatherIcon(code) {
            // Puedes expandir esto para más códigos
            if (code >= 0 && code <= 3) return 'sunny'; // Sol, parcialmente nublado
            if (code >= 51 && code <= 65) return 'rainy'; // Lluvia
            if (code >= 71 && code <= 75) return 'snowy'; // Nieve
            if (code >= 95 && code <= 99) return 'thunderstorm'; // Tormenta
            return 'cloudy'; // Por defecto
        }

        // Función principal para actualizar datos
        async function actualizarDatos() {
            document.getElementById('update-time').textContent = "Actualizando...";

            // Actualiza cada estación por separado
            await Promise.all([
                obtenerDatosWunderground(estaciones.primary.id) // Usar estaciones.primary.id
                    .then(datos => actualizarEstacion(datos, 'primary')) // Prefijo 'primary'
                    .catch(error => mostrarError(error.message || "Error al actualizar datos Cerro Otto", 'primary')), // Corrección: mostrarError
                obtenerDatosWunderground(estaciones.secondary.id) // Usar estaciones.secondary.id
                    .then(datos => actualizarEstacion(datos, 'secondary')) // Prefijo 'secondary'
                    .catch(error => mostrarError(error.message || "Error al actualizar datos Villa Catedral", 'secondary')), // Corrección: mostrarError
                obtenerDatosWunderground(estaciones.tertiary.id) // Usar estaciones.tertiary.id
                    .then(datos => actualizarEstacion(datos, 'tertiary')) // Prefijo 'tertiary'
                    .catch(error => mostrarError(error.message || "Error al actualizar datos Lomas del Cauquén", 'tertiary')), // Corrección: mostrarError
                cargarPronostico().catch(error => {
                    console.error("Error cargando pronóstico:", error);
                    document.getElementById('forecast-container').innerHTML = 
                        '<div class="error">Pronóstico no disponible. Actualiza la página.</div>';
                })
            ]);

            document.getElementById('update-time').textContent = `Última actualización: ${new Date().toLocaleTimeString('es-AR')}`;
        }


        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            actualizarDatos();
            setInterval(actualizarDatos, 15 * 60 * 1000); // Actualiza cada 15 minutos
        });
    </script>
</body>
</html>